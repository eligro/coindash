import React, { Component } from 'react'
import { Link, browserHistory } from 'react-router'
import { bindActionCreators } from 'redux'
import { connect } from 'react-redux'
import FontAwesome from 'react-fontawesome'
import { Button } from 'react-bootstrap'
import { NoAuthPage as Page, Card, Analytics } from 'osi/components'
import { Logo } from 'osi/bits'
import './login.css'
import packageJson from '../../../../../package.json'
import * as userActions from '../../../../actions/user.actions'
import Spinner from 'osi/bits/spinner'

import Paper from 'osi/bits/paper'

import TextField from 'material-ui/TextField'

export class LoginPage extends Component {
  constructor (props) {
    super(props)
    this.state = {
      waitingOnLogin: false,
      inputs: { }
    }
  }

  componentWillUpdate (nextProps) {
    if (nextProps.user.loggedIn) this.onLogin()
  }

  onLogin () {
    Analytics.event({ category: 'User', action: 'Identify', label: this.state.inputs.ident, nonInteraction: false })
    browserHistory.push('/dashboard')
  }

  signinButton (name, title, {disabled = false}) {
    return <Button className={`signin-with ${name}`} disabled={disabled} onClick={() => this.signinWith(name)} block><FontAwesome name={name} /> Sign in with {title}</Button>
  }
  signinWith (provider) {

  }
  handleChanges (newValue) {
    this.setState(newValue)
  }

  handleLogin (event) {
    const email = this.refs.email.getValue()
    const password = this.refs.password.getValue()

    event.preventDefault()

    Analytics.event({category: 'User', action: 'Identify', label: email.replace(/[@.]/, '-'), nonInteraction: false})
    this.setState({ waitingOnLogin: true })
    this.props.userActions.login(email, password)
      .then(() => {
        this.onLogin()
      })
      .catch(error => {
        this.setState({userError: error, waitingOnLogin: false})
      })
  }

  valueChanged (inputName) {
    const input = this.state.inputs[inputName]
    return (event, value) => ((input && !value) || (!input && value)) &&
        this.setState({ inputs: { ...this.state.inputs, [inputName]: !!value } })
  }

//
// {this.signinButton('google', 'Google', {disabled: true})}
// {this.signinButton('facebook', 'Facebook', {disabled: true})}
// <span className='seperator'>Or</span>
//
  render () {
    return (
      <Page className={['login', this.state.waitingOnLogin && 'is-loading'].join(' ')}>
        <Paper>
          <Card className='login' title='&nbsp;' headerActions={<Link to='/'><FontAwesome name='times' /></Link>}>
            <div className='brand'>
              <Logo version={packageJson.version} />
            </div>

            <h3>Sign In</h3>
            <div className='up'>
              <form onSubmit={this.handleLogin.bind(this)}>
                <TextField
                  ref='email'
                  type='text'
                  floatingLabelText='Email'
                  onChange={this.valueChanged('email')}
                  hintText='your@name.com'
                  errorText={this.state.userError && this.state.userError.code && this.state.userError.code &&
                    (
                      this.state.userError.code.match(/email|user-not-found|user-disabled/)

                    ) && this.state.userError.message}
                   />

                <TextField id='password'
                  ref='password'
                  type='password'
                  floatingLabelText='Password'
                  onChange={this.valueChanged('password')}
                  errorText={this.state.userError && this.state.userError.code && this.state.userError.code.match(/password/) && this.state.userError.message} />

                <Button type='submit' disabled={!this.state.inputs.password || !this.state.inputs.email} onClick={this.handleLogin.bind(this)} bsStyle='primary' block>Continue</Button>
              </form>

              <hr />
              <div className='beta-test'>
                <p>First time beta tester? <Link to='/login/reset-password'>Reset Password</Link></p>
              </div>
            </div>
            {this.state.waitingOnLogin && <Spinner />}

          </Card>
        </Paper>
      </Page>

    )
  }
}

function mapStateToProps (state, ownProps) {
  return {
    user: state.user
  }
}

function mapDispatchToProps (dispatch) {
  return {
    userActions: bindActionCreators(userActions, dispatch)
  }
}

export default connect(mapStateToProps, mapDispatchToProps)(LoginPage)
