import React, { Component } from 'react'
import { Link, browserHistory } from 'react-router'
import { bindActionCreators } from 'redux'
import { connect } from 'react-redux'
import Trianglify from 'react-trianglify'
import FontAwesome from 'react-fontawesome'
import { FormGroup, ControlLabel, FormControl, HelpBlock, Button } from 'react-bootstrap'
import { debounce } from 'lodash'
import { Page, Card, Analytics } from 'osi/components'
import { Logo } from 'osi/bits'
import './login.css'
import packageJson from '../../../../../package.json'
import * as userActions from '../../../../actions/user.actions'

function FieldGroup ({ id, label, help, className, ...props }) {
  return (
    <FormGroup controlId={id} className={className}>
      <ControlLabel>{label}</ControlLabel>
      <FormControl {...props} />
      {help && <HelpBlock>{help}</HelpBlock>}
    </FormGroup>
  )
}

class LoginPage extends Component {
  constructor (props) {
    super(props)
    this.state = {
      waitingOnLogin: false,
      inputs: {
        email: '',
        password: '',
        member: false
      },
      seed: 'Coindash by Eli Sklar',
      width: window.innerWidth,
      height: window.innerHeigh,
      pattern: {
        variance: 25,
        cell_size: 50,
        x_colors: ['#fff7fb', '#ece2f0', '#d0d1e6', '#a6bddb', '#67a9cf', '#3690c0', '#02818a', '#016c59', '#014636'],
        y_colors: ['#ffffd9', '#edf8b1', '#c7e9b4', '#7fcdbb', '#41b6c4', '#1d91c0', '#225ea8', '#253494', '#081d58']
      }
    }

    this.handleChange = debounce((newValue) => {
      this.handleChanges({inputs: {ident: newValue}})
    }, 180)
  }

  componentWillUpdate (nextProps) {
    if (nextProps.user.loggedIn) this.onLogin()
  }

  onLogin () {
    Analytics.event({ category: 'User', action: 'Identify', label: this.state.inputs.ident, nonInteraction: false })
    browserHistory.push('/dashboard')
  }

  signinButton (name, title, {disabled = false}) {
    return <Button className={`signin-with ${name}`} disabled={disabled} onClick={() => this.signinWith(name)} block><FontAwesome name={name} /> Sign in with {title}</Button>
  }
  signinWith (provider) {

  }
  handleChanges (newValue) {
    this.setState(newValue)
  }

  handleLogin (event) {
    Analytics.event({category: 'User', action: 'Identify', label: this.state.inputs.email.replace(/[@.]/, '-'), nonInteraction: false})
    this.setState({ waitingOnLogin: true });
    this.props.userActions.login(this.state.inputs.email, this.state.inputs.password)
  }

  componentDidMount () {
    this.updateWindowDimensions()
    window.addEventListener('resize', this.updateWindowDimensions.bind(this))
  }

  componentWillUnmount () {
    window.removeEventListener('resize', this.updateWindowDimensions.bind(this))
  }

  updateWindowDimensions () {
    this.setState({ width: window.innerWidth, height: window.innerHeight })
  }
//
// {this.signinButton('google', 'Google', {disabled: true})}
// {this.signinButton('facebook', 'Facebook', {disabled: true})}
// <span className='seperator'>Or</span>
//
  render () {
    let {width, height, seed} = this.state
    let key = `${width}-${height}-${seed}`
    return (
      <Page className='login'>
        <div className='tbg' key={key}>
          <Trianglify width={this.state.width} height={this.state.height} seed={this.state.seed} {...this.state.pattern} />
        </div>
        <Card className='login' title='&nbsp;' headerActions={<Link to='/'><FontAwesome name='times' /></Link>}>
          <div className='brand'>
            <Logo version={packageJson.version} />
          </div>

          <h3>Sign In</h3>
          <div className='up'>
            <form onSubmit={ this.handleLogin }>
              <FieldGroup className={!!this.state.inputs.email && 'has-value'}
                type='text'
                label='Email'
                placeholder='Email'
                onChange={e => this.setState({
                  inputs: { ...this.state.inputs, email: e.target.value }
                })}/>
              <FieldGroup id='password'
                type='password'
                label='Password'
                placeholder='Password'
                onChange={e => this.setState({inputs: { ...this.state.inputs, password: e.target.value }})}/>
              <Button disabled={!this.state.inputs.email && !this.state.inputs.password} onClick={this.handleLogin.bind(this)} bsStyle='primary' block>Continue</Button>
            </form>
          </div>

        </Card>
      </Page>

    )
  }
}

function mapStateToProps (state, ownProps) {
  return {
    user: state.user
  }
}

function mapDispatchToProps (dispatch) {
  return {
    userActions: bindActionCreators(userActions, dispatch),
  }
}

export default connect(mapStateToProps, mapDispatchToProps)(LoginPage)
